version: 2
jobs:
  dockerhubuploadrelease:
     machine: true
     steps:
       - checkout
       - run: docker build -f docker/Dockerfile -t lilitumerenwen/test:test2 .
       - run: docker login -u "$DOCKER_HUB_USERNAME" -p "$DOCKER_HUB_PASSWORD" 
       - run: docker push lilitumerenwen/test:test2

  testrun:
     docker:
       - image: circleci/python:3.6.4
     enviroment:
       PIPENV_VENV_IN_PROJECT: true

     steps:
       - checkout
       - run: cd synapse
       - run: sudo pip install pipenv
       - run: sudo apt-get install build-essential python3-dev libffi-dev \
             # - run:
             # command: |
             # python-pip python-setuptools sqlite3 \
             # libssl-dev python-virtualenv libjpeg-dev libxslt1-dev
       - run: pipenv install
       - run: pipenv run python -m synapse.app.homeserver --server-name my.test.domain --config-path homeserver.yaml --generate-config --report-stats=yes
       - run:
           name: run tests
           command: |
             python -m twisted.trial tests 

workflows:
  version: 2
  build:
    jobs: 
      - testrun:
          filters:
           branches:
            only: master
      - approval:
          type: approval
      - dockerhubuploadrelease:
          requires: approval
          filters:
           branches:
            only: master
